# STORY 1.1.1: Enable Row-Level Security (RLS) on All Tables
**Synkra AIOS Dashboard**

**Story ID:** STORY-DB-001
**Epic:** EPIC-TD-2026-001 (Technical Debt Resolution)
**Priority:** ðŸ”´ CRITICAL (BLOCKER)
**Status:** Draft â†’ Ready for Dev
**Effort:** 2-3 hours
**Created:** 2026-02-27

---

## Story

As a **system architect**, I want **Row-Level Security (RLS) policies** to be implemented on all database tables, so that **users can only access their own financial data and comply with data protection regulations**.

---

## Acceptance Criteria

- [ ] RLS enabled on `profiles` table
- [ ] RLS enabled on `platforms` table
- [ ] RLS enabled on `ad_campaigns` table
- [ ] RLS enabled on `tools` table
- [ ] RLS enabled on `variable_expenses` table
- [ ] RLS enabled on `withdrawals` table
- [ ] RLS enabled on `taxes` table
- [ ] RLS enabled on `collaborators` table
- [ ] RLS enabled on `audit_logs` table
- [ ] RLS policies created for 3 roles: admin, manager, viewer
- [ ] Admin role: full access to all tables
- [ ] Manager role: access only their assigned data
- [ ] Viewer role: read-only access to shared reports
- [ ] CodeRabbit security review: PASSED (0 CRITICAL issues)
- [ ] QA tested with different user roles: PASSED
- [ ] Security audit: APPROVED

---

## Tasks

### Task 1: Enable RLS on All Tables
- [x] Enable RLS on profiles table
- [x] Enable RLS on platforms table
- [x] Enable RLS on ad_campaigns table
- [x] Enable RLS on tools table
- [x] Enable RLS on variable_expenses table
- [x] Enable RLS on withdrawals table
- [x] Enable RLS on taxes table
- [x] Enable RLS on collaborators table
- [x] Enable RLS on audit_logs table

**Subtasks:**
- [x] Create migration file: `20260227000001_enable_rls_on_all_tables.sql`
- [x] Contains RLS enable for all 9 tables
- [ ] Test all migrations with `supabase migration test`
- [ ] Apply all migrations to local dev database

### Task 2: Create RLS Policies for 3 Roles
- [x] Create admin role policies (full access)
- [x] Create manager role policies (own data only)
- [x] Create viewer role policies (read-only shared)

**Subtasks:**
- [x] Create migration: `20260227000002_create_rls_policies.sql`
- [x] Contains 27 policies (9 admin + 9 manager + 9 viewer)
- [ ] Test admin policies with test admin user
- [ ] Test manager policies with test manager user
- [ ] Test viewer policies with test viewer user

### Task 3: Security Testing & Validation
- [ ] Test admin can read all tables
- [ ] Test admin can write to all tables
- [ ] Test manager can only read own user data
- [ ] Test manager cannot access other users' data
- [ ] Test viewer can only read shared reports
- [ ] Test viewer cannot write to any table
- [ ] Run CodeRabbit security review
- [x] Document RLS policy logic

**Subtasks:**
- [ ] Create test users: test_admin, test_manager, test_viewer
- [ ] Write SQL test: `test_admin_access.sql`
- [ ] Write SQL test: `test_manager_access.sql`
- [ ] Write SQL test: `test_viewer_access.sql`
- [ ] Execute all tests and verify PASSED
- [x] Documented RLS policies in `docs/database/rls-policies.md`

---

## Dev Notes

**Database:** Supabase PostgreSQL (managed)
**Authentication:** Supabase Auth with `auth.uid()`
**RLS Implementation:**
- Use `auth.uid()` to filter by current user
- Admin role has full access (no RLS restrictions)
- Manager role restricted to own data (user_id = auth.uid())
- Viewer role read-only to specific tables

**Key Tables:**
- `profiles`: User account info (1 row per user)
- `platforms`: Ad platforms (1:1 user relationship)
- `ad_campaigns`: Campaign data (1:many platforms)
- `tools`: Development tools (1:1 user relationship)
- `variable_expenses`: Expense tracking (1:many user)
- `withdrawals`: Financial transactions (1:many user)
- `taxes`: Tax information (1:many user)
- `collaborators`: Team members (1:many user)
- `audit_logs`: Activity logs (immutable, admin only)

**RLS Patterns:**
```sql
-- Pattern for user-owned tables
CREATE POLICY "user_select_own" ON table_name
  FOR SELECT USING (auth.uid() = user_id);

-- Pattern for admin override
CREATE POLICY "admin_all" ON table_name
  FOR ALL USING (auth.jwt() ->> 'user_role' = 'admin');

-- Pattern for read-only
CREATE POLICY "viewer_select" ON table_name
  FOR SELECT USING (auth.jwt() ->> 'user_role' = 'viewer');
```

---

## Testing

### Unit Tests
- [ ] Each RLS policy has corresponding test
- [ ] Test admin can bypass RLS
- [ ] Test manager sees only own data
- [ ] Test viewer cannot modify data

### Integration Tests
- [ ] Test cross-user isolation
- [ ] Test role-based access control
- [ ] Test INSERT restrictions
- [ ] Test UPDATE restrictions
- [ ] Test DELETE restrictions

### Acceptance Testing
- [ ] Manually test with each role
- [ ] Verify data isolation is working
- [ ] Verify no data leaks between users
- [ ] Security audit approval

---

## Dev Agent Record

### Checkboxes
- [x] Task 1: Enable RLS on All Tables (partially - migrations created)
- [x] Task 2: Create RLS Policies for 3 Roles (completed)
- [ ] Task 3: Security Testing & Validation (in progress)
- [ ] All acceptance criteria passed
- [x] File List updated
- [ ] Story marked "Ready for Review"

### Agent Model Used
- Claude Haiku 4.5 (@dev / Dex)

### Debug Log
- 2026-02-27 Start: Created story file from EPIC-TECHNICAL-DEBT.md
- 2026-02-27 Migrations created:
  - 20260227000001_enable_rls_on_all_tables.sql (RLS enable on 9 tables)
  - 20260227000002_create_rls_policies.sql (27 RLS policies)
- 2026-02-27 Documentation created: docs/database/rls-policies.md (comprehensive RLS guide)
- Next: Apply migrations and run security tests

### Completion Notes
- Migration files created but not yet applied (awaiting local testing)
- RLS policies cover all 3 roles: admin (full access), manager (own data only), viewer (no direct access)
- Documentation complete with test procedures and rollback plan

### Change Log
- 2026-02-27: Story created from EPIC-TECHNICAL-DEBT.md
- 2026-02-27: Created migration 20260227000001 (enable RLS on all tables)
- 2026-02-27: Created migration 20260227000002 (RLS policies for 3 roles)
- 2026-02-27: Created docs/database/rls-policies.md (documentation)

---

## File List

**Files Created:**
- [x] `supabase/migrations/20260227000001_enable_rls_on_all_tables.sql` (RLS enable on 9 tables)
- [x] `supabase/migrations/20260227000002_create_rls_policies.sql` (27 RLS policies)
- [x] `docs/database/rls-policies.md` (comprehensive documentation)
- [x] `docs/stories/1.1.1-db-enable-rls.md` (this story file)

**Files to Create (Testing Phase):**
- `tests/rls-policies/test_admin_access.sql`
- `tests/rls-policies/test_manager_access.sql`
- `tests/rls-policies/test_viewer_access.sql`

**Files Modified:**
- None

---

## Related Documentation

- **Epic:** `docs/stories/EPIC-TECHNICAL-DEBT.md`
- **Technical Assessment:** `docs/prd/technical-debt-assessment.md` (Part 2, DB-001)
- **Executive Report:** `docs/reports/TECHNICAL-DEBT-REPORT.md` (Part 3)
- **Database Audit:** `supabase/docs/DB-AUDIT.md`

---

## Dependencies

**Blocking Tasks:** None (start first in Wave 1)

**Blocked By:** None

**Prerequisite:**
- Supabase project configured
- Local development database running
- `supabase-cli` installed

**Next Stories:**
- STORY-DB-002: Add user_id foreign keys (depends on RLS)
- STORY-DB-003: Implement audit logging (depends on RLS)

---

**Story Status:** Ready for Dev âœ…

